name: Query Regression Tests

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
      - develop

jobs:
  regression-tests:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-cloud-bigquery google-auth pyyaml
      
      - name: Authenticate with GCP
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          if [ -z "$GCP_SA_KEY" ]; then
            echo "ERROR: GCP_SA_KEY secret not configured"
            exit 1
          fi
          echo "$GCP_SA_KEY" > /tmp/gcp-key.json
          echo "GCP_SA_KEY_FILE=/tmp/gcp-key.json" >> $GITHUB_ENV
      
      - name: Initialize test results file
        run: |
          python tests/init_test_results.py
      
      - name: Run query regression tests
        run: |
          python tests/run_regression_tests.py \
            --query-dir queries \
            --output tests/QUERY_TEST_RESULTS.md \
            --json-output tests/query_test_results.json \
            --credentials ${{ env.GCP_SA_KEY_FILE }} || true
      
      - name: Update query headers with execution stats
        run: |
          python tests/update_query_headers.py \
            --results tests/query_test_results.json \
            --threshold 0.10 \
            --query-dir queries || true
      
      - name: Generate test summary for PR comment
        if: github.event_name == 'pull_request'
        run: |
          python << 'EOF'
          import json
          
          with open('tests/query_test_results.json') as f:
              results = json.load(f)
          
          # Categorize results
          pass_queries = [r for r in results if r['status'] == 'Pass']
          pending_queries = [r for r in results if r['status'] == 'Pending Review']
          error_queries = [r for r in results if r['status'] not in ['Pass', 'Pending Review']]
          
          # Calculate stats
          total_cost = sum(r['estimated_cost_usd'] for r in pass_queries if r['estimated_cost_usd'])
          
          # Generate comment markdown
          comment = f"""## Query Regression Test Results

          **Summary:**
          - ✅ **Pass:** {len(pass_queries)} queries
          - ⏳ **Pending Review:** {len(pending_queries)} queries
          - ❌ **Errors:** {len(error_queries)} queries
          
          **Total Estimated Cost:** ${total_cost:.4f}
          
          [View Full Results](https://github.com/${{ github.repository }}/blob/${{ github.head_ref }}/tests/QUERY_TEST_RESULTS.md)
          
          """
          
          if error_queries:
              comment += "\n### Errors\n"
              for q in error_queries[:10]:  # Show first 10
                  error_msg = q['dry_run_error'] or q['execution_error'] or 'Unknown'
                  error_msg = error_msg[:100]  # Truncate long errors
                  comment += f"- **{q['name']}** ({q['status']}): {error_msg}\n"
          
          # Write to file for posting
          with open('/tmp/pr_comment.txt', 'w') as f:
              f.write(comment)
          EOF
          
          cat /tmp/pr_comment.txt
      
      - name: Post PR comment with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('/tmp/pr_comment.txt', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Commit stat updates if changed
        if: github.event_name == 'push'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Check if any files changed
          if git diff --quiet queries/; then
            echo "No query file changes"
          else
            echo "Committing stat updates..."
            git add queries/
            git commit -m "Update query stats from regression tests" || true
            git push
          fi
      
      - name: Check for test failures
        run: |
          python << 'EOF'
          import json
          import sys
          
          with open('tests/query_test_results.json') as f:
              results = json.load(f)
          
          # Check production queries only
          production = [r for r in results if not r['is_pending']]
          failures = [r for r in production if r['status'] != 'Pass']
          
          if failures:
              print(f"\n❌ {len(failures)} production query test(s) failed:\n")
              for f in failures:
                  error = f['dry_run_error'] or f['execution_error'] or f['status']
                  print(f"  - {f['name']}: {error}\n")
              sys.exit(1)
          else:
              print(f"\n✅ All {len(production)} production queries passed!")
              sys.exit(0)
          EOF
      
      - name: Upload test results as artifact
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: query-test-results
          path: |
            tests/QUERY_TEST_RESULTS.md
            tests/query_test_results.json
          retention-days: 30
